---
title: "Predicting .. from Spotify Music"
author: Alyssia Goodwin & Nolan Guzman & Arthur Diaz
date: "May 3, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#Data Input and Preprocessing 

## Intro

We are using the "Now That's What I Call Music(U.S. releases)" data set from Kaggle to predict the danceability of a song. Danceability is described with how much a song will get people todance from the tempo, rhythm stability, beat, and regulatiry. The scale of danceability ranges from 0 to 1, 0 being the least danceable while 1 is the most danceable song. 



## Preprocessing 

Looking at the data there does not seem to be any null data within the database. From looking at the database it deo

```{r,echo=TRUE}
library(rpart)
library(rpart.plot)
library(maptree)
library(e1071)
library(cluster)

# the following utility files can be found attached to the assignment
source("https://raw.githubusercontent.com/grbruns/cst383/master/lin-regr-util.R")
source("https://raw.githubusercontent.com/grbruns/cst383/master/class-util.R")

dat=read.csv("data.csv")

sum(is.null(dat))
dat$X = NULL
dat$loudness=abs(dat$loudness)
dat$song_title = NULL
dat$instrumentalness = NULL

dat$danceability=dat$danceability*100
dat$energy=dat$energy*100
dat$acousticness=dat$acousticness*100
dat$liveness=dat$liveness*100
dat$valence=dat$valence*100
dat$speechiness=dat$speechiness*100

```

#Data Exploration

```{r}
dat$song_title=NULL
summary(dat)
```


```{r, echo=TRUE}
fit=lm(danceability ~ acousticness+energy+liveness+loudness+speechiness+valence, data=dat)

summary(fit)

par(mfrow=c(2,2))
plot(density(dat$danceability),col="red",main="Density of Features", ylim = c(0,.07))
lines(density(dat$energy),col="green")
lines(density(dat$liveness),col="blue")

legend("topright",legend=c("Dance","Energy","Liveness"),col=c("Red","Green","Blue"),lty=1,cex=.7)

plot(ecdf(dat$danceability),col="red",main="ECDF of Features")
lines(ecdf(dat$energy),col="green")
lines(ecdf(dat$liveness),col="blue")
legend("bottomright",legend=c("Dance","Energy","Liveness"),col=c("Red","Green","Blue"),lty=1,cex=.7)

plot(danceability ~ energy, data=dat, col="red",main="Danceability by Energy")
plot(danceability ~ liveness, data=dat, col="red",main="Danceability by Liveness")

```

```{r,echo=TRUE}

set.seed(123)
split = split_data(dat)
tr_dat = split[[1]]
te_dat = split[[2]]

fit1=lm(danceability ~ energy+liveness, data=tr_dat)
predicts=predict(fit1, te_dat)
actual=te_dat$danceability
rng=range(c(predicts,actual))

plot(actual ~ predicts, pch=20, main="Predicted Danceablity Vs. Actual",col="red")
lines(c(rng[1],rng[2]),c(rng[1],rng[2]),lty=2,col="blue",lwd=1.5)

```

```{r, echo=TRUE}

par(mfrow=c(2,2))
plot(fit1)
summary(fit1)
mse=mean((actual-predicts)^2)
rmse=sqrt(mse)
cat("\nRoot Mean Square: ",rmse)

```

```{r, echo=TRUE}

te_dat$artist=NULL
te_dat$key=NULL
te_dat$mode=NULL
te_dat$target=NULL
te_dat$time_signature=NULL
te_dat$duration_ms=NULL
te_dat$tempo=NULL

par(mfrow=c(1,2))
hc=hclust(dist(te_dat),method="complete")
clusters=cutree(hc,10)
cols=rainbow(10)[clusters]
plot(danceability ~ energy,data=te_dat,col=cols,pch=16,main="Danceability by Energy, n=10")
plot(danceability ~ liveness,data=te_dat,col=cols,pch=16,main="Danceability by Liveness, n=10")

fit2=kmeans(te_dat,10)
cat("Betweenss of fit: ",fit2$betweenss)
cat("Totss of fit: ",fit2$totss)
cat("Betweenss/Totss", (fit2$betweenss/fit2$totss))

sil=silhouette(fit2$cluster,dist(te_dat))
cat("Silhouette Width", mean(sil[,3]))

hc=hclust(dist(te_dat),method="complete")
clusters=cutree(hc,100)
cols=rainbow(100)[clusters]
plot(danceability ~ energy,data=te_dat,col=cols,pch=16,main="Danceability by Energy, n=100")
plot(danceability ~ liveness,data=te_dat,col=cols,pch=16,main="Danceability by Liveness, n=100")

fit3=kmeans(te_dat,100)

cat("Betweenss of fit: ",fit3$betweenss)
cat("Totss of fit: ",fit3$totss)
cat("Betweenss/Totss", (fit3$betweenss/fit3$totss))

sil2=silhouette(fit3$cluster,dist(te_dat))
cat("Silhouette Width",mean(sil2[,3]))

```

```{r, echo=TRUE}
fit = rpart(danceability ~ energy +liveness, data = tr_dat)
prp(fit, extra=1, varlen=-10, main="Regression Tree for Danceability (tr_dat)",box.col= "green")

```

```{r, echo=TRUE}
predicted = predict(fit, te_dat)
errors = te_dat$danceability - predicted
rmse = sqrt(mean(errors^2))

plot_predict_actual(predicted, actual, 2, "Regression Tree Danceablility Prediction")
```

```{r, echo=TRUE}
hist(errors, col = "red4", main = "Histogram of Errors, Regression Tree")
```

```{r, echo=TRUE}

par(mfrow=c(2,2))
plot(density(dat$danceability),col="red",main="Density of Features")
lines(density(dat$energy),col="green")
lines(density(dat$valence),col="blue")

legend("topright",legend=c("Dance","Energy","Valence"),col=c("Red","Green","Blue"),lty=1,cex=.7)

plot(ecdf(dat$danceability),col="red",main="ECDF of Features")
lines(ecdf(dat$energy),col="green")
lines(ecdf(dat$valence),col="blue")
legend("bottomright",legend=c("Dance","Energy","Valence"),col=c("Red","Green","Blue"),lty=1,cex=.7)

plot(danceability ~ energy, data=dat, col="red",main="Danceability by Energy")
plot(danceability ~ valence, data=dat, col="red",main="Danceability by Valence")

```


```{r,echo=TRUE}
fit4 = lm(danceability ~ energy+valence, data=tr_dat)
predicts1 = predict(fit4, newdata=te_dat, type="response")
actual1=te_dat$danceability
rang = range(c(predicts1, actual1))
par(mfrow=c(1,1))
plot(predicts1 ~ actual1, main="Predicting Danceability using Energy and Valence", ylab = "Prediction", xlab="Actuals", col="red", pch=20)
lines(c(rang[1], rang[2]),
      c(rang[1], rang[2]), col="blue",lty=2)
```

```{r, echo=TRUE}

par(mfrow=c(2,2))
plot(fit4)

mse1=mean((actual1-predicts1)^2)
rmse1=sqrt(mse1)
cat("Root Mean Square: ",rmse1)
```


From the graphs exploring the tree of the data of Valence and Energy to danceability using testing data and training and seeing the comparison of them. 
```{r,echo=TRUE}

par(mfrow=c(1,2))
hc=hclust(dist(te_dat),method="complete")
clusters=cutree(hc,10)
cols=rainbow(10)[clusters]
plot(danceability ~ energy,data=te_dat,col=cols,pch=16,main="Danceability by Energy, n=10")
plot(danceability ~ valence,data=te_dat,col=cols,pch=16,main="Danceability by Valence, n=10")

fit2=kmeans(te_dat,10)
cat("Betweenss of fit: ",fit2$betweenss)
cat("Totss of fit: ",fit2$totss)
cat("Betweenss/Totss", (fit2$betweenss/fit2$totss))

sil=silhouette(fit2$cluster,dist(te_dat))
cat("Silhouette Width", mean(sil[,3]))

hc=hclust(dist(te_dat),method="complete")
clusters=cutree(hc,100)
cols=rainbow(100)[clusters]
plot(danceability ~ energy,data=te_dat,col=cols,pch=16,main="Danceability by Energy, n=100")
plot(danceability ~ valence,data=te_dat,col=cols,pch=16,main="Danceability by Valence, n=100")

fit3=kmeans(te_dat,100)

cat("Betweenss of fit: ",fit3$betweenss)
cat("Totss of fit: ",fit3$totss)
cat("Betweenss/Totss", (fit3$betweenss/fit3$totss))

sil2=silhouette(fit3$cluster,dist(te_dat))
cat("Silhouette Width",mean(sil2[,3]))

```

```{r,echo=TRUE}
fit5 = rpart(danceability ~ energy +valence, data = tr_dat)
prp(fit5, extra=1, varlen=-10, main="Regression Tree for Danceability (tr_dat)",box.col= "green")
fit6 = rpart(danceability ~ energy +valence, data = te_dat)
prp(fit6, extra=1, varlen=-10, main="Regression Tree for Danceability (te_dat)",box.col= "green")
```
```{r,echo=TRUE}
predicted = predict(fit5, te_dat)
errors = te_dat$danceability - predicted
rmse = sqrt(mean(errors^2))

plot_predict_actual(predicted, actual, 2, "Regression Tree Danceablility Prediction")
```

```{r,echo=TRUE}
hist(errors, col = "red4", main = "Histogram of Errors, Regression Tree")
```



```{r,echo=TRUE}
dat$dance=ifelse(dat$danceability>70,1,0)
fit=glm(dance ~ energy + valence, data=dat,family=binomial)
summary(fit)
```

```{r,echo=TRUE}

#dat$dance=as.factor(dat$dance)

split = split_data(dat)
tr_dat = split[[1]]
te_dat = split[[2]]

fit=glm(dance ~ energy + valence,data=tr_dat,family=binomial)

y=predict(fit,newdata=te_dat,type="response")
predicts=as.numeric(y>.7)
actuals=te_dat$dance
table(predicts,actuals)
cat("\nAccuracy of predictions: ",mean(predicts==actuals))

```

```{r, echo=TRUE}

fit1=glm(dance ~ energy, data=dat, family=binomial)
fit2=glm(dance ~ valence, data=dat, family=binomial)
temp1=data.frame(energy=seq(min(dat$energy),max(dat$energy),10))
temp2=data.frame(valence=seq(min(dat$valence),max(dat$valence),10))


probs1=predict(fit1,newdata=temp1,type="response")
probs2=predict(fit2,newdata=temp2,type="response")

plot(dance ~ energy,data=tr_dat,col="red",pch=20,ylab="P(danceability)")
lines(temp1$energy,probs1,col="blue",lwd=2)

plot(dance ~ valence,data=tr_dat,col="red",pch=20,ylab="P(danceability)")
lines(temp2$valence,probs2,col="blue",lwd=2)

```

```{r,echo=TRUE}

fit.1=glm(dance ~ energy + valence, data=tr_dat,family=binomial)
predicts=predict(fit.1,te_dat,type="response")
actuals=te_dat$dance

plot(density(predicts[actuals==1]),col="red",xlab="Logistic Regression output",main="Double Density of Energy and Valence",ylim=c(0,3.0))
legend("topright",col=c("red","blue"),legend=c("Danceable","Not Danceable"),lty=1)
lines(density(predicts[actuals==0]),col="blue",lwd=2)

```



